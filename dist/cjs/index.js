/*! For license information please see index.js.LICENSE.txt */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.cbor=t():e.cbor=t()}(this,(()=>(()=>{"use strict";var e={d:(t,r)=>{for(var i in r)e.o(r,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:r[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{DataInStream:()=>i,DataOutStream:()=>a,Decoder:()=>n,Encoder:()=>c,IDREFHandler:()=>l,KeyDictionaryHandler:()=>f,MemoryInStream:()=>s,MemoryOutStream:()=>d,TagHandler:()=>r,TypeMapHandler:()=>u});class r{constructor(e){this.options=e||{}}encode(e,t){return e}decode(e,t){}startEncoding(e){}finishEncoding(e){}finishDecoding(e,t){}createArray(e){return[]}createObject(e,t){return t?Object.create(t):{}}encodeKey(e,t){if(!/^_/.test(e))return e}decodeKey(e,t){return e}}class i{readFloat16(){throw Error("DataInStream.readFloat16")}readFloat32(){throw Error("DataInStream.readFloat32")}readFloat64(){throw Error("DataInStream.readFloat64")}readUint8(){throw Error("DataInStream.readUint8")}readUint16(){throw Error("DataInStream.readUint16")}readUint32(){throw Error("DataInStream.readUint32")}readUint64(){}readUint8Array(e){throw Error("DataInStream.readUint8Array")}peekUint8(){throw Error("DataInStream.peekUint8")}get mark(){throw Error("DataInStream.get mark")}set mark(e){throw Error("DataInStream.set mark")}}class s extends i{view=void 0;readPos=0;constructor(e){if(super(),e instanceof DataView)this.view=e;else if(e instanceof ArrayBuffer)this.view=new DataView(e,0,e.length);else{if(!e.buffer||"number"!=typeof e.byteLength||"number"!=typeof e.byteOffset)throw console.log(e),Error("MemoryInStream: data unusable");this.view=new DataView(e.buffer,e.byteOffset,e.byteLength)}}peekUint8(){return this.view.getUint8(this.readPos)}readUint8(){const e=this.view.getUint8(this.readPos);return this.readPos+=1,e}readUint16(){const e=this.view.getUint16(this.readPos);return this.readPos+=2,e}readUint32(){const e=this.view.getUint32(this.readPos);return this.readPos+=4,e}readUint64(){return 4294967296*this.readUint32()+this.readUint32()}readFloat16(){const e=new ArrayBuffer(4),t=new DataView(e),r=this.readUint16(),i=32768&r;let s=31744&r;const n=1023&r;if(31744===s)s=261120;else if(0!==s)s+=114688;else if(0!==n)return(i?-1:1)*n*5.960464477539063e-8;return t.setUint32(0,i<<16|s<<13|n<<13),t.getFloat32(0)}readFloat32(){const e=this.view.getFloat32(this.readPos);return this.readPos+=4,e}readFloat64(){const e=this.view.getFloat64(this.readPos);return this.readPos+=8,e}readUint8Array(e){const t=new Uint8Array(this.view.buffer,this.view.byteOffset+this.readPos,e);return this.readPos+=e,t}}class n{constructor(e,t){this.stream=e,this.tagHandler=t||new r}readBreak(){return 255===this.stream.peekUint8()&&(this.stream.readUint8(),!0)}readArgument(e,t){if(e<24)return e;switch(e){case 24:return this.stream.readUint8();case 25:return this.stream.readUint16();case 26:return this.stream.readUint32();case 27:return this.stream.readUint64();case 31:switch(t){case 0:case 1:case 6:break;default:return-1}}throw Error(`Malformed ${t} ${e}`)}readIndefiniteBytes(e){const t=()=>{const t=this.stream.readUint8(),r=t>>5,i=31&t;if(31===i)return-1;if(r!==e)throw Error(`Major type mismatch on chunk ${r}!=${e}`);const s=this.readArgument(i,e);if(s<0)throw Error(`Invalid chunk length ${s}`);return s},r=[];let i,s=0;for(;(i=t())>=0;)this.debug&&this.debug(`\tCHUNK ${i} bytes`),s+=i,r.push(this.stream.readUint8Array(i));const n=new Uint8Array(s);let a=0;for(let e=0;e<r.length;e++)n.set(r[e],a),a+=r[e].length;return n}readItemArray(e){let t=this.tagHandler.createArray(this);for(let r=0;r<e;r++)t.push(this.decodeItem());return t}readIndefiniteItemArray(){const e=this.tagHandler.createArray(this);for(;!this.readBreak();)e.push(this.decodeItem());return e}readKV(e){const t=this.tagHandler.createObject(this);for(let r=0;r<e;r++){let e=this.decodeItem();e=this.tagHandler.decodeKey(e,this),t[e]=this.decodeItem()}return t}readIndefiniteKV(){const e=this.tagHandler.createObject(this);for(;!this.readBreak();)e[this.decodeItem()]=this.decodeItem();return e}decodeItem(){const e=this.stream.readUint8(),t=e>>5,r=31&e;let i,s,n,a;switch(t){case 0:return this.debug&&this.debug(`${this.stream.readPos}: UINT ${r}`),this.readArgument(r,0);case 1:return this.debug&&this.debug(`${this.stream.readPos}: -INT ${r}`),-1-this.readArgument(r,1);case 2:if(this.debug&&this.debug(`${this.stream.readPos}: BYTES ${r}`),31===r)return this.readIndefiniteBytes(t);if(i=this.readArgument(r,2),i<0)throw Error(`Invalid byte string length ${i}`);return this.stream.readUint8Array(i);case 3:if(31===r)this.debug&&this.debug(`${this.stream.readPos}: TEXT? ${r}`),n=(new TextDecoder).decode(this.readIndefiniteBytes(t));else{if(this.debug&&this.debug(`${this.stream.readPos}: TEXT `),i=this.readArgument(r,3),i<0)throw Error(`Invalid text length ${i}`);n=(new TextDecoder).decode(this.stream.readUint8Array(i))}return this.debug&&this.debug(`\t"${n}"`),n;case 4:if(31===r)return this.debug&&this.debug(`${this.stream.readPos}: ARRAY?`),this.readIndefiniteItemArray();if(i=this.readArgument(r,4),i<0)throw Error("Invalid array length ${len}");return this.debug&&this.debug(`${this.stream.readPos}: ARRAY ${i}`),this.readItemArray(i);case 5:if(31===r)return this.debug&&this.debug(`${this.stream.readPos}: MAP?`),this.readIndefiniteKV();if(i=this.readArgument(r,5),i<0)throw Error("Invalid map length ${len}");return this.debug&&this.debug(`${this.stream.readPos}: MAP length ${i}`),this.readKV(i);case 6:if(s=this.readArgument(r,6),this.debug&&this.debug(`${this.stream.readPos}: TAG ${s}`),a=this.tagHandler.decode(s,this),void 0!==a)return a;switch(s){case 0:case 1:return new Date(this.decodeItem())}return this.decodeItem();case 7:switch(this.debug&&this.debug(`${this.stream.readPos}: OTHER ${r}`),r){case 20:return!1;case 21:return!0;case 22:return null;case 23:return;case 24:return this.stream.readUint8();case 25:return this.stream.readFloat16();case 26:return this.stream.readFloat32();case 27:return this.stream.readFloat64()}return r}throw Error(`Unrecognised major type ${t}`)}decodes(){const e=this.decodeItem();return this.tagHandler.finishDecoding(this,e),e}static decode(e,t,r){const i=new s(e),a=new n(i,t);return a.debug=r,a.decodes()}}class a{writeUint8(e){throw Error("DataStream.writeUint8")}writeUint16(e){throw Error("DataStream.writeUint16")}writeUint32(e){throw Error("DataStream.writeUint32")}writeUint64(e){throw Error("DataStream.writeUint64")}writeFloat32(e){throw Error("DataStream.writeFloat32")}writeFloat64(e){throw Error("DataStream.writeFloat64")}writeUint8Array(e){for(let t=0;t<e.length;++t)this.writeUint8(this.writePos++,e[t])}}const o=2**32;class d extends a{view=new DataView(new ArrayBuffer(256));writePos=0;appendSpaceFor(e){const t=this.writePos+e,r=this.view.buffer.byteLength;let i=r;for(;i<t;)i*=2;if(i!==r){const e=new ArrayBuffer(i);new Uint8Array(e).set(new Uint8Array(this.view.buffer)),this.view=new DataView(e)}}writeUint8(e){this.appendSpaceFor(1),this.view.setUint8(this.writePos,e),this.writePos++}writeUint16(e){this.appendSpaceFor(2),this.view.setUint16(this.writePos,e),this.writePos+=2}writeUint32(e){this.appendSpaceFor(4),this.view.setUint32(this.writePos,e),this.writePos+=4}writeUint64(e){const t=e%o,r=(e-t)/o;this.writeUint32(r),this.writeUint32(t)}writeFloat32(e){this.appendSpaceFor(4),this.view.setFloat32(this.writePos,e),this.writePos+=4}writeFloat64(e){this.appendSpaceFor(8),this.view.setFloat64(this.writePos,e),this.writePos+=8}writeUint8Array(e){this.appendSpaceFor(e.length);for(let t=0;t<e.length;++t)this.view.setUint8(this.writePos++,e[t])}get Uint8Array(){return new Uint8Array(this.view.buffer,0,this.writePos)}}const h=2**53;class c{constructor(e,t){this.stream=e,this.tagger=t||new r}writeTypeAndArgument(e,t){t<24?this.stream.writeUint8(e<<5|t):t<256?(this.stream.writeUint8(e<<5|24),this.stream.writeUint8(t)):t<65536?(this.stream.writeUint8(e<<5|25),this.stream.writeUint16(t)):t<4294967296?(this.stream.writeUint8(e<<5|26),this.stream.writeUint32(t)):(this.stream.writeUint8(e<<5|27),this.stream.writeUint64(t))}writeTag(e){this.writeTypeAndArgument(6,e)}encodeItem(e){if(!1===e)return void this.stream.writeUint8(244);if(!0===e)return void this.stream.writeUint8(245);if(null===e)return void this.stream.writeUint8(246);if(void 0===e)return void this.stream.writeUint8(247);switch(typeof e){case"number":if(Math.floor(e)===e){if(0<=e&&e<=h)return void this.writeTypeAndArgument(0,e);if(-h<=e&&e<0)return void this.writeTypeAndArgument(1,-(e+1))}return this.stream.writeUint8(251),void this.stream.writeFloat64(e);case"string":{const t=(new TextEncoder).encode(e);this.writeTypeAndArgument(3,t.length),this.stream.writeUint8Array(t)}return;case"function":throw Error("Can't CBOR function")}if(e instanceof Date)return this.writeTag(1),void this.encodeItem(e.getTime());if(void 0===(e=this.tagger.encode(e,this)))return;if(Array.isArray(e)){this.writeTypeAndArgument(4,e.length);for(let t=0;t<e.length;++t)this.encodeItem(e[t]);return}if(e instanceof Uint8Array)return this.writeTypeAndArgument(2,e.length),void this.stream.writeUint8Array(e);const t=Object.keys(e).filter((e=>void 0!==this.tagger.encodeKey(e,this))),r=t.length;this.writeTypeAndArgument(5,r);for(const r of t)this.encodeItem(this.tagger.encodeKey(r,this)),this.encodeItem(e[r])}encodes(e){this.tagger.startEncoding(this),this.encodeItem(e),this.tagger.finishEncoding(this)}static encode(e,t,r){const i=new d,s=new c(i,t);return s.debug=r,s.encodes(e),i.Uint8Array}}const u=e=>class extends e{constructor(e){super(e),this.typeMap=this.options.typeMap||{},this.pendingProto=void 0}encode(e,t){let r=e.constructor;for(;r&&"Object"!==r.name;){if(this.typeMap[r.name]){t.writeTag(25443),t.encodeItem(r.name),t.debug&&t.debug(`\t'${e.constructor.name}' marked as ${r.name}`);break}r=Object.getPrototypeOf(r)}return super.encode(e,t)}decode(e,t){if(25443!==e)return super.decode(e,t);{const e=t.decodeItem();t.debug&&t.debug("Tag: CN",e);const r=this.typeMap[e];if(!r)throw Error(`${e} missing from type map`);this.pendingProto=r.prototype}}createObject(e){let t;return this.pendingProto?(t=Object.create(this.pendingProto),this.pendingProto=void 0):t=super.createObject(e),t}},w=new RegExp("^ആଈ(.+)$"),g="ρѓσςεรຂεϑ",f=e=>class extends e{constructor(e){super(e),this.k2i={},this.i2k=[],this.options.keys&&this.options.keys.forEach((e=>{this.k2i[e]=this.i2k.length,this.i2k.push(e)})),this.i2k_added=[]}finishEncoding(e){super.finishEncoding(e),e.encodeItem(this.i2k_added)}finishDecoding(e,t){super.finishDecoding(e,t),this.i2k_added=e.decodeItem(),this.options.debug&&this.options.debug(`Read ${this.i2k_added.length} added keys`),function(e,t){const r=[];!function e(i){if("object"==typeof i&&null!==i){if(Array.isArray(i)){for(const t of i)e(t);return}if(i[g])return;r.push(i),i[g]=!0;const s=Object.keys(i);for(const r of s){e(i[r]);const s=w.exec(r);s&&(i[t[s[1]]]=i[r],delete i[r])}}}(e);for(const e of r)delete e[g]}(t,[...this.i2k,...this.i2k_added])}encodeKey(e,t){if(void 0===super.encodeKey(e,this))return void(this.options.debug&&this.options.debug(`\tKDh ignore ${e}`));if(!this.i2k)return e;let r=this.k2i[e];return void 0===r&&(this.k2i[e]=r=this.i2k.length+this.i2k_added.length,this.options.added&&this.options.added(e,r),this.i2k_added.push(e)),r}decodeKey(e,t){return e<this.i2k.length?this.i2k[e]:`ആଈ${e}`}},m="_Í",l=e=>class extends e{constructor(e){super(e),this.objectsFrozen=[],this.objectsThawed={},this.currentID=void 0}finishDecoding(e,t){super.finishDecoding(e,t),this.objectsThawed={}}finishEncoding(e){super.finishEncoding(e);for(const e of this.objectsFrozen)delete e[m];this.objectsFrozen=[]}encode(e,t){if("object"==typeof e){if(void 0!==e[m])return t.writeTag(25442),void t.encodeItem(e[m]);const r=this.objectsFrozen.length;t.writeTag(25444),t.encodeItem(r),e[m]=r,this.objectsFrozen.push(e)}return super.encode(e,t)}decode(e,t){let r,i;switch(e){case 25444:return this.currentID=r=t.decodeItem(),t.debug&&t.debug("\tIDREF: ID=",r),t.decodeItem();case 25442:if(i=t.decodeItem(),t.debug&&t.debug("\tIDREF: REF to",i),!this.objectsThawed[i])throw Error(`Reference to unthawed ${i}`);return this.objectsThawed[i]}return super.decode(e,t)}createArray(e){const t=super.createArray(e);return void 0!==this.currentID&&(this.objectsThawed[this.currentID]=t,e.debug&&e.debug("\tIDREF: created []",this.currentID),this.currentID=void 0),t}createObject(e,t){const r=super.createObject(e,t);return void 0!==this.currentID&&(this.objectsThawed[this.currentID]=r,e.debug&&e.debug("\tIDREF: created {}",this.currentID),this.currentID=void 0),r}};return t})()));